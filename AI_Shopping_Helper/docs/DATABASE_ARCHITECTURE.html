<!DOCTYPE html>
<html>
<head>
<title>DATABASE_ARCHITECTURE.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="%F0%9F%97%84%EF%B8%8F-database-architecture-documentation">🗄️ Database Architecture Documentation</h1>
<h2 id="ai-shopping-helper---complete-database-technology-stack">AI Shopping Helper - Complete Database Technology Stack</h2>
<hr>
<h2 id="%F0%9F%93%8B-table-of-contents">📋 Table of Contents</h2>
<ol>
<li><a href="#system-overview">System Overview</a></li>
<li><a href="#database-technologies">Database Technologies</a></li>
<li><a href="#schema-design">Schema Design</a></li>
<li><a href="#vector-database--embeddings">Vector Database &amp; Embeddings</a></li>
<li><a href="#search-architecture">Search Architecture</a></li>
<li><a href="#data-flow">Data Flow</a></li>
<li><a href="#performance-optimizations">Performance Optimizations</a></li>
<li><a href="#api-integration">API Integration</a></li>
<li><a href="#deployment-architecture">Deployment Architecture</a></li>
</ol>
<hr>
<h2 id="1-system-overview">1. System Overview</h2>
<h3 id="%F0%9F%8E%AF-purpose">🎯 Purpose</h3>
<p>AI Shopping Helper uses a <strong>hybrid database architecture</strong> combining:</p>
<ul>
<li><strong>PostgreSQL</strong> - Relational data storage for products, prices, and metadata</li>
<li><strong>ChromaDB</strong> - Vector database for CLIP embeddings and semantic search</li>
<li><strong>SQLite</strong> - Fallback lightweight database for development</li>
</ul>
<h3 id="%F0%9F%8F%97%EF%B8%8F-architecture-type">🏗️ Architecture Type</h3>
<p><strong>Microservices-based Multi-Database Architecture</strong></p>
<pre class="hljs"><code><div>┌─────────────────────────────────────────────────────────────┐
│                     CLIENT LAYER                            │
│              (React/Next.js Frontend)                       │
└──────────────────┬──────────────────────────────────────────┘
                   │ HTTP/REST API
┌──────────────────▼──────────────────────────────────────────┐
│                   FASTAPI BACKEND                           │
│  ┌──────────────┬────────────────┬────────────────────┐    │
│  │   Hybrid     │   Product      │    Price           │    │
│  │   Search     │   Management   │    Tracking        │    │
│  │   Engine     │   API          │    API             │    │
│  └──────┬───────┴────────┬───────┴────────┬───────────┘    │
└─────────┼────────────────┼────────────────┼────────────────┘
          │                │                │
┌─────────▼────────┐ ┌────▼────────┐ ┌────▼────────────────┐
│   ChromaDB       │ │ PostgreSQL   │ │  SQLite (Fallback)  │
│   (Vectors)      │ │ (Products)   │ │  (Development)      │
│                  │ │              │ │                     │
│ • 768-dim CLIP   │ │ • Products   │ │ • Local testing     │
│   embeddings     │ │ • Listings   │ │ • Rapid prototyping │
│ • Cosine         │ │ • Prices     │ │                     │
│   similarity     │ │ • History    │ │                     │
│ • Fast retrieval │ │ • Feedback   │ │                     │
└──────────────────┘ └──────────────┘ └─────────────────────┘
</div></code></pre>
<hr>
<h2 id="2-database-technologies">2. Database Technologies</h2>
<h3 id="21-postgresql-primary-database">2.1 PostgreSQL (Primary Database)</h3>
<p><strong>Version:</strong> PostgreSQL 12+<br>
<strong>Purpose:</strong> Primary relational database for structured data</p>
<h4 id="%F0%9F%94%A7-key-features-used">🔧 Key Features Used</h4>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Usage</th>
<th>Benefit</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>JSONB</strong></td>
<td>Product specifications storage</td>
<td>Flexible schema, indexed queries</td>
</tr>
<tr>
<td><strong>UUID</strong></td>
<td>Global product IDs</td>
<td>Distributed system support</td>
</tr>
<tr>
<td><strong>Full-Text Search (tsvector)</strong></td>
<td>Product name/keyword search</td>
<td>Fast text searching</td>
</tr>
<tr>
<td><strong>GIN Indexes</strong></td>
<td>JSONB and text search</td>
<td>10x faster JSON queries</td>
</tr>
<tr>
<td><strong>Triggers</strong></td>
<td>Auto-update timestamps</td>
<td>Data consistency</td>
</tr>
<tr>
<td><strong>Views</strong></td>
<td>Pre-aggregated data</td>
<td>Query performance</td>
</tr>
<tr>
<td><strong>Foreign Keys</strong></td>
<td>Referential integrity</td>
<td>Data consistency</td>
</tr>
</tbody>
</table>
<h4 id="%F0%9F%93%8A-connection-details">📊 Connection Details</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Database URL Format</span>
DATABASE_URL = <span class="hljs-string">"postgresql://username:password@host:port/database"</span>

<span class="hljs-comment"># Example (from .env)</span>
DATABASE_URL = <span class="hljs-string">"postgresql://postgres:password@localhost:5432/hypelens_db"</span>

<span class="hljs-comment"># SQLAlchemy Engine Configuration</span>
engine = create_engine(
    DATABASE_URL,
    pool_pre_ping=<span class="hljs-literal">True</span>,      <span class="hljs-comment"># Test connections before use</span>
    pool_size=<span class="hljs-number">10</span>,            <span class="hljs-comment"># Connection pool size</span>
    max_overflow=<span class="hljs-number">20</span>,         <span class="hljs-comment"># Additional connections allowed</span>
    pool_timeout=<span class="hljs-number">30</span>          <span class="hljs-comment"># Wait time for connection</span>
)
</div></code></pre>
<h4 id="%F0%9F%94%90-security-features">🔐 Security Features</h4>
<ol>
<li><strong>Parameterized Queries</strong> - SQL injection prevention</li>
<li><strong>Connection Pooling</strong> - Resource management</li>
<li><strong>SSL Support</strong> - Encrypted connections</li>
<li><strong>Role-Based Access</strong> - User permissions</li>
</ol>
<hr>
<h3 id="22-chromadb-vector-database">2.2 ChromaDB (Vector Database)</h3>
<p><strong>Version:</strong> ChromaDB 0.4.x<br>
<strong>Purpose:</strong> Store and retrieve CLIP image embeddings</p>
<h4 id="%F0%9F%8E%AF-vector-database-architecture">🎯 Vector Database Architecture</h4>
<pre class="hljs"><code><div>┌───────────────────────────────────────────────────────────┐
│                    CHROMADB STRUCTURE                     │
├───────────────────────────────────────────────────────────┤
│                                                           │
│  Collection: &quot;product_embeddings&quot;                         │
│  ┌─────────────────────────────────────────────────────┐ │
│  │  Document ID: global_product_id (UUID)              │ │
│  │  ┌───────────────────────────────────────────────┐  │ │
│  │  │  Embedding: [768-dimensional float32 vector]  │  │ │
│  │  │  [0.234, -0.456, 0.789, ..., 0.123]          │  │ │
│  │  │                                                │  │ │
│  │  │  Model: ViT-L/14 (CLIP OpenAI)                │  │ │
│  │  │  Dimensions: 768                               │  │ │
│  │  │  Distance Metric: Cosine Similarity            │  │ │
│  │  └───────────────────────────────────────────────┘  │ │
│  │                                                      │ │
│  │  Metadata:                                           │ │
│  │  {                                                   │ │
│  │    &quot;product_name&quot;: &quot;Samsung Galaxy S24&quot;,            │ │
│  │    &quot;category&quot;: &quot;Smartphone&quot;,                        │ │
│  │    &quot;brand&quot;: &quot;Samsung&quot;,                              │ │
│  │    &quot;price&quot;: 79999.00,                               │ │
│  │    &quot;description&quot;: &quot;Flagship smartphone...&quot;          │ │
│  │  }                                                   │ │
│  └─────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────┘
</div></code></pre>
<h4 id="%F0%9F%94%A2-embedding-generation-process">🔢 Embedding Generation Process</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Step 1: Load CLIP Model</span>
model = <span class="hljs-string">"ViT-L-14"</span>  <span class="hljs-comment"># 304M parameters, 768-dim embeddings</span>
device = <span class="hljs-string">"cpu"</span>      <span class="hljs-comment"># Can use GPU for faster processing</span>

<span class="hljs-comment"># Step 2: Generate Image Embedding</span>
image_bytes = upload_file.read()
image = Image.open(BytesIO(image_bytes))
image_tensor = preprocess(image).unsqueeze(<span class="hljs-number">0</span>)

<span class="hljs-keyword">with</span> torch.no_grad():
    image_embedding = model.encode_image(image_tensor)
    image_embedding = image_embedding / image_embedding.norm(dim=<span class="hljs-number">-1</span>, keepdim=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># Result: 768-dimensional normalized vector</span>
<span class="hljs-comment"># Shape: (1, 768)</span>
<span class="hljs-comment"># Values: [-1.0, 1.0] (normalized)</span>
</div></code></pre>
<h4 id="%F0%9F%93%88-storage-specifications">📈 Storage Specifications</h4>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Value</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Vector Dimension</strong></td>
<td>768</td>
<td>ViT-L/14 output size</td>
</tr>
<tr>
<td><strong>Data Type</strong></td>
<td>float32</td>
<td>4 bytes per dimension</td>
</tr>
<tr>
<td><strong>Storage per Vector</strong></td>
<td>3 KB</td>
<td>768 × 4 bytes</td>
</tr>
<tr>
<td><strong>Metadata Size</strong></td>
<td>~2 KB</td>
<td>JSON metadata</td>
</tr>
<tr>
<td><strong>Total per Product</strong></td>
<td>~5 KB</td>
<td>Vector + metadata</td>
</tr>
<tr>
<td><strong>1000 Products</strong></td>
<td>~5 MB</td>
<td>Scalable storage</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="23-sqlite-fallback-database">2.3 SQLite (Fallback Database)</h3>
<p><strong>Version:</strong> SQLite 3.x<br>
<strong>Purpose:</strong> Development and testing fallback</p>
<h4 id="%F0%9F%93%81-file-structure">📁 File Structure</h4>
<pre class="hljs"><code><div>data/
├── shopping_assistant.db        # Main SQLite database
└── shopping_assistant_test.db   # Testing database
</div></code></pre>
<h4 id="%F0%9F%94%84-automatic-fallback-mechanism">🔄 Automatic Fallback Mechanism</h4>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_default_sqlite_url</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-string">"""Fallback to SQLite if PostgreSQL unavailable"""</span>
    os.makedirs(<span class="hljs-string">"data"</span>, exist_ok=<span class="hljs-literal">True</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">"sqlite:///data/shopping_assistant.db"</span>

<span class="hljs-comment"># Connection Logic</span>
DATABASE_URL = os.getenv(<span class="hljs-string">"DATABASE_URL"</span>) <span class="hljs-keyword">or</span> _default_sqlite_url()
</div></code></pre>
<hr>
<h2 id="3-schema-design">3. Schema Design</h2>
<h3 id="31-postgresql-schema">3.1 PostgreSQL Schema</h3>
<h4 id="%F0%9F%93%8A-table-productsglobal">📊 Table: <code>products_global</code></h4>
<p><strong>Purpose:</strong> Store unique products (deduplicated across stores)</p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products_global (
    <span class="hljs-comment">-- Primary Key (UUID for distributed systems)</span>
    global_product_id <span class="hljs-keyword">UUID</span> PRIMARY <span class="hljs-keyword">KEY</span> <span class="hljs-keyword">DEFAULT</span> gen_random_uuid(),
    
    <span class="hljs-comment">-- Core Product Information</span>
    <span class="hljs-keyword">name</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">500</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    brand <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    <span class="hljs-keyword">category</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    description <span class="hljs-built_in">TEXT</span>,
    
    <span class="hljs-comment">-- Flexible Specifications (JSONB)</span>
    specifications JSONB <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'{}'</span>,
    <span class="hljs-comment">/* Example:
    {
        "processor": "Apple M2",
        "ram": "8GB",
        "storage": "256GB SSD",
        "display": "13.6-inch Retina"
    }
    */</span>
    
    <span class="hljs-comment">-- Images</span>
    image_url <span class="hljs-built_in">TEXT</span>,
    
    <span class="hljs-comment">-- Search Optimization</span>
    search_keywords <span class="hljs-built_in">TEXT</span>,  <span class="hljs-comment">-- TF-IDF search</span>
    
    <span class="hljs-comment">-- Vector Embedding Reference</span>
    embedding_vector BYTEA,  <span class="hljs-comment">-- 768-dim CLIP embedding (optional inline)</span>
    
    <span class="hljs-comment">-- Metadata</span>
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    updated_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    
    <span class="hljs-comment">-- Analytics</span>
    total_searches <span class="hljs-built_in">INTEGER</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    last_searched_at <span class="hljs-built_in">TIMESTAMP</span>
);
</div></code></pre>
<p><strong>Indexes:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Performance Indexes</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_products_brand <span class="hljs-keyword">ON</span> products_global(brand);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_products_category <span class="hljs-keyword">ON</span> products_global(<span class="hljs-keyword">category</span>);

<span class="hljs-comment">-- Full-Text Search</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_products_name 
    <span class="hljs-keyword">ON</span> products_global <span class="hljs-keyword">USING</span> gin(to_tsvector(<span class="hljs-string">'english'</span>, <span class="hljs-keyword">name</span>));

<span class="hljs-comment">-- JSONB Search</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_products_specs 
    <span class="hljs-keyword">ON</span> products_global <span class="hljs-keyword">USING</span> gin(specifications);
</div></code></pre>
<h4 id="%F0%9F%93%8A-table-listingsscraped">📊 Table: <code>listings_scraped</code></h4>
<p><strong>Purpose:</strong> Store prices from multiple stores for each product</p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> listings_scraped (
    <span class="hljs-comment">-- Primary Key</span>
    listing_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    
    <span class="hljs-comment">-- Foreign Key to products_global</span>
    global_product_id <span class="hljs-keyword">UUID</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> 
        <span class="hljs-keyword">REFERENCES</span> products_global(global_product_id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">CASCADE</span>,
    
    <span class="hljs-comment">-- Store Information</span>
    store_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,      <span class="hljs-comment">-- "Flipkart", "Amazon", "Croma"</span>
    store_product_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),        <span class="hljs-comment">-- Store's internal ID</span>
    
    <span class="hljs-comment">-- Pricing Information</span>
    price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    original_price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>),        <span class="hljs-comment">-- Before discount</span>
    discount_percentage <span class="hljs-built_in">INTEGER</span>,           <span class="hljs-comment">-- Calculated discount</span>
    
    <span class="hljs-comment">-- Availability</span>
    in_stock <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">true</span>,
    stock_quantity <span class="hljs-built_in">INTEGER</span>,
    
    <span class="hljs-comment">-- URLs</span>
    product_url <span class="hljs-built_in">TEXT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,             <span class="hljs-comment">-- Affiliate link</span>
    image_url <span class="hljs-built_in">TEXT</span>,                        <span class="hljs-comment">-- Store-specific image</span>
    
    <span class="hljs-comment">-- Shipping</span>
    shipping_cost <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0.00</span>,
    estimated_delivery_days <span class="hljs-built_in">INTEGER</span>,
    
    <span class="hljs-comment">-- Seller Information</span>
    seller_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    seller_rating <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">3</span>, <span class="hljs-number">2</span>),           <span class="hljs-comment">-- 0.00 to 5.00</span>
    
    <span class="hljs-comment">-- Metadata</span>
    last_scraped_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    last_price_change_at <span class="hljs-built_in">TIMESTAMP</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    
    <span class="hljs-comment">-- Data Source</span>
    <span class="hljs-keyword">source</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'manual'</span>,   <span class="hljs-comment">-- "api", "manual", "scraper"</span>
    scraper_version <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    
    <span class="hljs-comment">-- Analytics</span>
    click_count <span class="hljs-built_in">INTEGER</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    conversion_count <span class="hljs-built_in">INTEGER</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>
);
</div></code></pre>
<p><strong>Unique Constraint:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Prevent duplicate listings from same store</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">INDEX</span> idx_unique_product_store 
    <span class="hljs-keyword">ON</span> listings_scraped(global_product_id, store_name, store_product_id);
</div></code></pre>
<h4 id="%F0%9F%93%8A-table-pricehistory">📊 Table: <code>price_history</code></h4>
<p><strong>Purpose:</strong> Track historical prices for price drop alerts</p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> price_history (
    history_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    listing_id <span class="hljs-built_in">INTEGER</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> 
        <span class="hljs-keyword">REFERENCES</span> listings_scraped(listing_id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">CASCADE</span>,
    price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    recorded_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- Time-series index</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_price_history_listing 
    <span class="hljs-keyword">ON</span> price_history(listing_id, recorded_at);
</div></code></pre>
<h4 id="%F0%9F%93%8A-table-userfeedback">📊 Table: <code>user_feedback</code></h4>
<p><strong>Purpose:</strong> Store user ratings and feedback</p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_feedback (
    <span class="hljs-keyword">id</span> BIGSERIAL PRIMARY <span class="hljs-keyword">KEY</span>,
    product_id <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">REFERENCES</span> products(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">CASCADE</span>,
    user_rating <span class="hljs-built_in">INT</span>,                        <span class="hljs-comment">-- 1-5 stars</span>
    is_helpful <span class="hljs-built_in">BOOLEAN</span>,
    comments <span class="hljs-built_in">TEXT</span>,
    user_ip <span class="hljs-built_in">TEXT</span>,
    created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NOW</span>()
);
</div></code></pre>
<h3 id="32-database-views">3.2 Database Views</h3>
<h4 id="%F0%9F%94%8D-view-productswithbestprice">🔍 View: <code>products_with_best_price</code></h4>
<p><strong>Purpose:</strong> Quick access to products with lowest available price</p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">VIEW</span> products_with_best_price <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> 
    p.global_product_id,
    p.name,
    p.brand,
    p.category,
    p.image_url,
    p.specifications,
    <span class="hljs-keyword">MIN</span>(l.price) <span class="hljs-keyword">as</span> best_price,
    <span class="hljs-keyword">COUNT</span>(l.listing_id) <span class="hljs-keyword">as</span> total_listings,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> l.in_stock <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> available_stores
<span class="hljs-keyword">FROM</span> 
    products_global p
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> 
    listings_scraped l <span class="hljs-keyword">ON</span> p.global_product_id = l.global_product_id
<span class="hljs-keyword">WHERE</span> 
    l.in_stock = <span class="hljs-literal">true</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> 
    p.global_product_id, p.name, p.brand, p.category, 
    p.image_url, p.specifications;
</div></code></pre>
<p><strong>Usage:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Get top 10 cheapest smartphones</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products_with_best_price
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">category</span> = <span class="hljs-string">'Smartphone'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> best_price <span class="hljs-keyword">ASC</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;
</div></code></pre>
<h3 id="33-database-functions">3.3 Database Functions</h3>
<h4 id="%E2%9A%99%EF%B8%8F-function-getproductwithlistings">⚙️ Function: <code>get_product_with_listings()</code></h4>
<p><strong>Purpose:</strong> Retrieve product and all store listings in single query</p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> get_product_with_listings(product_id <span class="hljs-keyword">UUID</span>)
<span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">JSON</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    <span class="hljs-keyword">result</span> <span class="hljs-keyword">JSON</span>;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span> json_build_object(
        <span class="hljs-string">'product'</span>, row_to_json(p.*),
        <span class="hljs-string">'listings'</span>, (
            <span class="hljs-keyword">SELECT</span> json_agg(row_to_json(l.*))
            <span class="hljs-keyword">FROM</span> listings_scraped l
            <span class="hljs-keyword">WHERE</span> l.global_product_id = p.global_product_id
            <span class="hljs-keyword">AND</span> l.in_stock = <span class="hljs-literal">true</span>
            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> l.price <span class="hljs-keyword">ASC</span>
        )
    ) <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">result</span>
    <span class="hljs-keyword">FROM</span> products_global p
    <span class="hljs-keyword">WHERE</span> p.global_product_id = product_id;
    
    RETURN result;
<span class="hljs-keyword">END</span>;
$$ LANGUAGE plpgsql;
</div></code></pre>
<p><strong>Usage:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Get product with all listings</span>
<span class="hljs-keyword">SELECT</span> get_product_with_listings(<span class="hljs-string">'550e8400-e29b-41d4-a716-446655440000'</span>);
</div></code></pre>
<h4 id="%E2%9A%99%EF%B8%8F-function-updatepriceifchanged">⚙️ Function: <code>update_price_if_changed()</code></h4>
<p><strong>Purpose:</strong> Update price and log to history if different</p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> update_price_if_changed(
    p_listing_id <span class="hljs-built_in">INTEGER</span>,
    p_new_price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>)
)
<span class="hljs-keyword">RETURNS</span> <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    old_price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>);
    price_changed BOOLEAN := false;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- Get current price</span>
    <span class="hljs-keyword">SELECT</span> price <span class="hljs-keyword">INTO</span> old_price
    <span class="hljs-keyword">FROM</span> listings_scraped
    <span class="hljs-keyword">WHERE</span> listing_id = p_listing_id;
    
    <span class="hljs-comment">-- Check if price changed</span>
    IF old_price IS NULL OR old_price != p_new_price THEN
        <span class="hljs-comment">-- Update listing</span>
        <span class="hljs-keyword">UPDATE</span> listings_scraped
        <span class="hljs-keyword">SET</span> 
            price = p_new_price,
            last_price_change_at = <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
            last_scraped_at = <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
        <span class="hljs-keyword">WHERE</span> listing_id = p_listing_id;
        
        <span class="hljs-comment">-- Log to price history</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> price_history (listing_id, price)
        <span class="hljs-keyword">VALUES</span> (p_listing_id, p_new_price);
        
        price_changed := true;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
    
    RETURN price_changed;
<span class="hljs-keyword">END</span>;
$$ LANGUAGE plpgsql;
</div></code></pre>
<hr>
<h2 id="4-vector-database--embeddings">4. Vector Database &amp; Embeddings</h2>
<h3 id="41-clip-model-architecture">4.1 CLIP Model Architecture</h3>
<p><strong>Model:</strong> OpenAI ViT-L/14<br>
<strong>Parameters:</strong> 304 Million<br>
<strong>Embedding Dimension:</strong> 768<br>
<strong>Training Data:</strong> 400M image-text pairs</p>
<h4 id="%F0%9F%A7%A0-model-specifications">🧠 Model Specifications</h4>
<pre class="hljs"><code><div>MODEL_SPECS = {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"ViT-L-14"</span>,
    <span class="hljs-string">"pretrained"</span>: <span class="hljs-string">"openai"</span>,
    <span class="hljs-string">"parameters"</span>: <span class="hljs-string">"304M"</span>,
    <span class="hljs-string">"embedding_dim"</span>: <span class="hljs-number">768</span>,
    <span class="hljs-string">"patch_size"</span>: <span class="hljs-number">14</span>,
    <span class="hljs-string">"image_resolution"</span>: <span class="hljs-number">224</span>,
    <span class="hljs-string">"architecture"</span>: <span class="hljs-string">"Vision Transformer (Large)"</span>,
    <span class="hljs-string">"training_dataset"</span>: <span class="hljs-string">"LAION-400M"</span>
}
</div></code></pre>
<h4 id="%F0%9F%94%84-embedding-pipeline">🔄 Embedding Pipeline</h4>
<pre class="hljs"><code><div>┌─────────────────────────────────────────────────────────────┐
│                 EMBEDDING GENERATION PIPELINE               │
└─────────────────────────────────────────────────────────────┘

Step 1: Image Upload
   │
   ├─→ User uploads image (JPG/PNG/WebP)
   │   Size: Max 10MB
   │   Format: RGB
   │
   ▼
Step 2: Image Preprocessing
   │
   ├─→ Resize to 224×224
   ├─→ Normalize: mean=[0.48145466, 0.4578275, 0.40821073]
   │              std=[0.26862954, 0.26130258, 0.27577711]
   ├─→ Convert to tensor
   │
   ▼
Step 3: CLIP Encoding
   │
   ├─→ Pass through Vision Transformer
   ├─→ Extract [CLS] token embedding
   ├─→ Output: 768-dimensional vector
   │
   ▼
Step 4: Normalization
   │
   ├─→ L2 normalization
   ├─→ embedding = embedding / ||embedding||
   ├─→ Range: [-1.0, 1.0]
   │
   ▼
Step 5: Storage
   │
   ├─→ ChromaDB: Store vector + metadata
   ├─→ PostgreSQL: Store reference (optional)
   │
   ▼
Step 6: Search
   │
   └─→ Cosine similarity with stored embeddings
       Score = (A · B) / (||A|| × ||B||)
</div></code></pre>
<h3 id="42-chromadb-configuration">4.2 ChromaDB Configuration</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> chromadb
<span class="hljs-keyword">from</span> chromadb.config <span class="hljs-keyword">import</span> Settings

<span class="hljs-comment"># Initialize ChromaDB client</span>
chroma_client = chromadb.PersistentClient(
    path=<span class="hljs-string">"data/chroma_db"</span>,  <span class="hljs-comment"># Local storage</span>
    settings=Settings(
        anonymized_telemetry=<span class="hljs-literal">False</span>,
        allow_reset=<span class="hljs-literal">True</span>
    )
)

<span class="hljs-comment"># Create or get collection</span>
collection = chroma_client.get_or_create_collection(
    name=<span class="hljs-string">"product_embeddings"</span>,
    metadata={
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"CLIP ViT-L/14 embeddings for product images"</span>,
        <span class="hljs-string">"model"</span>: <span class="hljs-string">"ViT-L-14"</span>,
        <span class="hljs-string">"dimension"</span>: <span class="hljs-number">768</span>,
        <span class="hljs-string">"distance_metric"</span>: <span class="hljs-string">"cosine"</span>
    }
)

<span class="hljs-comment"># Add embeddings</span>
collection.add(
    embeddings=[embedding_vector],      <span class="hljs-comment"># 768-dim numpy array</span>
    documents=[product_description],     <span class="hljs-comment"># Text description</span>
    metadatas=[{
        <span class="hljs-string">"product_id"</span>: <span class="hljs-string">"UUID"</span>,
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"Samsung Galaxy S24"</span>,
        <span class="hljs-string">"category"</span>: <span class="hljs-string">"Smartphone"</span>,
        <span class="hljs-string">"price"</span>: <span class="hljs-number">79999.00</span>
    }],
    ids=[<span class="hljs-string">"global_product_id"</span>]           <span class="hljs-comment"># Unique identifier</span>
)

<span class="hljs-comment"># Search similar products</span>
results = collection.query(
    query_embeddings=[query_embedding],
    n_results=<span class="hljs-number">10</span>,
    include=[<span class="hljs-string">"embeddings"</span>, <span class="hljs-string">"documents"</span>, <span class="hljs-string">"metadatas"</span>, <span class="hljs-string">"distances"</span>]
)
</div></code></pre>
<h3 id="43-embedding-storage-strategy">4.3 Embedding Storage Strategy</h3>
<h4 id="%F0%9F%92%BE-hybrid-storage-approach">💾 Hybrid Storage Approach</h4>
<table>
<thead>
<tr>
<th>Storage</th>
<th>Vectors</th>
<th>Metadata</th>
<th>Speed</th>
<th>Scalability</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ChromaDB</strong></td>
<td>✅ Primary</td>
<td>✅ Basic</td>
<td>⚡ Fast</td>
<td>⭐⭐⭐⭐</td>
</tr>
<tr>
<td><strong>PostgreSQL</strong></td>
<td>⚠️ Optional</td>
<td>✅ Full</td>
<td>🐢 Slower</td>
<td>⭐⭐⭐</td>
</tr>
</tbody>
</table>
<p><strong>Best Practice:</strong></p>
<ul>
<li><strong>ChromaDB:</strong> Store embeddings for fast similarity search</li>
<li><strong>PostgreSQL:</strong> Store detailed product metadata and relationships</li>
</ul>
<hr>
<h2 id="5-search-architecture">5. Search Architecture</h2>
<h3 id="51-hybrid-search-algorithm">5.1 Hybrid Search Algorithm</h3>
<p>The system uses a <strong>3-stage hybrid search</strong> combining:</p>
<ol>
<li><strong>CLIP Visual Search</strong> (50% weight)</li>
<li><strong>Keyword Text Search</strong> (30% weight)</li>
<li><strong>Exact Match Scoring</strong> (20% weight)</li>
</ol>
<h4 id="%F0%9F%94%8D-search-flow-diagram">🔍 Search Flow Diagram</h4>
<pre class="hljs"><code><div>┌─────────────────────────────────────────────────────────────┐
│                    HYBRID SEARCH FLOW                       │
└─────────────────────────────────────────────────────────────┘

INPUT: Image + Optional Query Text (&quot;Samsung S24&quot;)
   │
   ├─────────────────┬─────────────────┬──────────────────┐
   │                 │                 │                  │
   ▼                 ▼                 ▼                  ▼
┌─────────┐    ┌─────────┐      ┌─────────┐      ┌─────────┐
│ CLIP    │    │ Keyword │      │ Exact   │      │Category │
│ Visual  │    │ Search  │      │ Match   │      │ Filter  │
│ Search  │    │ (TF-IDF)│      │ Scoring │      │         │
└────┬────┘    └────┬────┘      └────┬────┘      └────┬────┘
     │              │                │                │
     │ 50 results   │ 50 results     │ Bonus/Penalty │ Extract
     │              │                │                │
     ▼              ▼                ▼                ▼
┌──────────────────────────────────────────────────────────┐
│            SCORE FUSION &amp; RANKING                        │
│                                                          │
│  Final Score = (0.5 × CLIP) + (0.3 × Keyword) +         │
│                (0.2 × Exact) × Category Penalty          │
│                                                          │
│  Category Match: 1.0x                                    │
│  Category Mismatch: 0.1x (90% penalty)                  │
│                                                          │
│  Brand Match: +30%                                       │
│  Model Match: +25%                                       │
└──────────────────┬───────────────────────────────────────┘
                   │
                   ▼
              TOP 10 RESULTS
         (Sorted by Final Score)
</div></code></pre>
<h3 id="52-search-implementation">5.2 Search Implementation</h3>
<h4 id="%F0%9F%93%9D-clip-visual-search">📝 CLIP Visual Search</h4>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clip_search</span><span class="hljs-params">(self, image_bytes: bytes, products: List[Dict], top_k: int = <span class="hljs-number">50</span>)</span>:</span>
    <span class="hljs-string">"""
    Visual similarity search using CLIP embeddings
    """</span>
    <span class="hljs-comment"># Generate query embedding</span>
    query_embedding = self.encode_image(image_bytes)
    
    <span class="hljs-comment"># Get product embeddings (cached)</span>
    <span class="hljs-keyword">if</span> self._cached_embeddings <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
        product_embeddings = self._cached_embeddings
    <span class="hljs-keyword">else</span>:
        descriptions = [p[<span class="hljs-string">'description'</span>] <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> products]
        product_embeddings = self.encode_text(descriptions)
    
    <span class="hljs-comment"># Calculate cosine similarity</span>
    similarities = cosine_similarity(
        query_embedding.reshape(<span class="hljs-number">1</span>, <span class="hljs-number">-1</span>),
        product_embeddings
    )[<span class="hljs-number">0</span>]
    
    <span class="hljs-comment"># Get top K results</span>
    top_indices = np.argsort(similarities)[-top_k:][::<span class="hljs-number">-1</span>]
    
    results = []
    <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> top_indices:
        results.append({
            **products[idx],
            <span class="hljs-string">'clip_score'</span>: float(similarities[idx]),
            <span class="hljs-string">'rank'</span>: len(results) + <span class="hljs-number">1</span>
        })
    
    <span class="hljs-keyword">return</span> results
</div></code></pre>
<h4 id="%F0%9F%93%9D-keyword-search-tf-idf">📝 Keyword Search (TF-IDF)</h4>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">keyword_search</span><span class="hljs-params">(self, query_text: str, products: List[Dict], top_k: int = <span class="hljs-number">50</span>)</span>:</span>
    <span class="hljs-string">"""
    Text-based keyword search using TF-IDF
    """</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.tfidf_vectorizer <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> query_text:
        <span class="hljs-keyword">return</span> []
    
    <span class="hljs-comment"># Transform query</span>
    query_vector = self.tfidf_vectorizer.transform([query_text])
    
    <span class="hljs-comment"># Calculate similarity</span>
    similarities = cosine_similarity(query_vector, self.tfidf_matrix)[<span class="hljs-number">0</span>]
    
    <span class="hljs-comment"># Get top K results</span>
    top_indices = np.argsort(similarities)[-top_k:][::<span class="hljs-number">-1</span>]
    
    results = []
    <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> top_indices:
        <span class="hljs-keyword">if</span> similarities[idx] &gt; <span class="hljs-number">0</span>:  <span class="hljs-comment"># Only relevant results</span>
            results.append({
                **products[idx],
                <span class="hljs-string">'keyword_score'</span>: float(similarities[idx]),
                <span class="hljs-string">'rank'</span>: len(results) + <span class="hljs-number">1</span>
            })
    
    <span class="hljs-keyword">return</span> results
</div></code></pre>
<h4 id="%F0%9F%93%9D-exact-match-scoring">📝 Exact Match Scoring</h4>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">apply_exact_match_scoring</span><span class="hljs-params">(self, results: List[Dict], query_text: str)</span>:</span>
    <span class="hljs-string">"""
    Bonus for exact brand/model matches
    """</span>
    scorer = ExactMatchScorer()
    
    <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> results:
        <span class="hljs-comment"># Extract query components</span>
        query_brand = scorer.extract_brand(query_text)
        query_model = scorer.extract_model(query_text)
        
        <span class="hljs-comment"># Extract product components</span>
        product_brand = result.get(<span class="hljs-string">'brand'</span>, <span class="hljs-string">''</span>)
        product_name = result.get(<span class="hljs-string">'name'</span>, <span class="hljs-string">''</span>)
        
        <span class="hljs-comment"># Calculate bonuses</span>
        brand_match = query_brand.lower() <span class="hljs-keyword">in</span> product_brand.lower()
        model_match = query_model.lower() <span class="hljs-keyword">in</span> product_name.lower()
        
        <span class="hljs-comment"># Apply bonuses</span>
        <span class="hljs-keyword">if</span> brand_match:
            result[<span class="hljs-string">'final_score'</span>] *= <span class="hljs-number">1.30</span>  <span class="hljs-comment"># +30% bonus</span>
        <span class="hljs-keyword">if</span> model_match:
            result[<span class="hljs-string">'final_score'</span>] *= <span class="hljs-number">1.25</span>  <span class="hljs-comment"># +25% bonus</span>
    
    <span class="hljs-keyword">return</span> results
</div></code></pre>
<h4 id="%F0%9F%93%9D-category-based-penalty">📝 Category-Based Penalty</h4>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">apply_category_penalty</span><span class="hljs-params">(self, results: List[Dict], query_category: str)</span>:</span>
    <span class="hljs-string">"""
    Apply heavy penalty for wrong category products
    """</span>
    <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> results:
        product_category = result.get(<span class="hljs-string">'category'</span>, <span class="hljs-string">''</span>).lower()
        
        <span class="hljs-keyword">if</span> product_category != query_category.lower():
            <span class="hljs-comment"># 90% penalty for wrong category</span>
            result[<span class="hljs-string">'final_score'</span>] *= <span class="hljs-number">0.10</span>
            result[<span class="hljs-string">'category_mismatch'</span>] = <span class="hljs-literal">True</span>
        <span class="hljs-keyword">else</span>:
            result[<span class="hljs-string">'category_mismatch'</span>] = <span class="hljs-literal">False</span>
    
    <span class="hljs-keyword">return</span> results
</div></code></pre>
<h3 id="53-score-fusion">5.3 Score Fusion</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">hybrid_search</span><span class="hljs-params">(self, image_bytes: bytes, query_text: str = <span class="hljs-string">""</span>, top_k: int = <span class="hljs-number">10</span>)</span>:</span>
    <span class="hljs-string">"""
    Complete hybrid search pipeline
    """</span>
    <span class="hljs-comment"># Step 1: CLIP Search</span>
    clip_results = self.clip_search(image_bytes, products, top_k=<span class="hljs-number">50</span>)
    
    <span class="hljs-comment"># Step 2: Keyword Search</span>
    <span class="hljs-keyword">if</span> query_text:
        keyword_results = self.keyword_search(query_text, products, top_k=<span class="hljs-number">50</span>)
    <span class="hljs-keyword">else</span>:
        keyword_results = []
    
    <span class="hljs-comment"># Step 3: Merge results</span>
    merged = self.merge_results(clip_results, keyword_results)
    
    <span class="hljs-comment"># Step 4: Calculate final scores</span>
    <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> merged:
        clip_score = result.get(<span class="hljs-string">'clip_score'</span>, <span class="hljs-number">0</span>)
        keyword_score = result.get(<span class="hljs-string">'keyword_score'</span>, <span class="hljs-number">0</span>)
        
        <span class="hljs-comment"># Weighted fusion</span>
        final_score = (<span class="hljs-number">0.5</span> * clip_score) + (<span class="hljs-number">0.3</span> * keyword_score)
        result[<span class="hljs-string">'final_score'</span>] = final_score
    
    <span class="hljs-comment"># Step 5: Apply exact match bonuses</span>
    <span class="hljs-keyword">if</span> query_text:
        merged = self.apply_exact_match_scoring(merged, query_text)
    
    <span class="hljs-comment"># Step 6: Extract category and apply penalty</span>
    <span class="hljs-keyword">if</span> query_text:
        query_category = self.extract_category(query_text)
        merged = self.apply_category_penalty(merged, query_category)
    
    <span class="hljs-comment"># Step 7: Sort by final score</span>
    merged.sort(key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-string">'final_score'</span>], reverse=<span class="hljs-literal">True</span>)
    
    <span class="hljs-comment"># Step 8: Return top K</span>
    <span class="hljs-keyword">return</span> merged[:top_k]
</div></code></pre>
<hr>
<h2 id="6-data-flow">6. Data Flow</h2>
<h3 id="61-product-insertion-flow">6.1 Product Insertion Flow</h3>
<pre class="hljs"><code><div>┌─────────────────────────────────────────────────────────────┐
│                  PRODUCT INSERTION FLOW                     │
└─────────────────────────────────────────────────────────────┘

Step 1: Product Scraping/API Fetch
   │
   ├─→ Flipkart API / Web Scraping
   ├─→ Extract: name, price, specs, image_url
   │
   ▼
Step 2: Insert into PostgreSQL (products_global)
   │
   ├─→ INSERT INTO products_global (...)
   ├─→ Get global_product_id (UUID)
   │
   ▼
Step 3: Generate CLIP Embedding
   │
   ├─→ Download product image
   ├─→ Generate 768-dim CLIP embedding
   │
   ▼
Step 4: Store in ChromaDB
   │
   ├─→ collection.add(
   │       embeddings=[vector],
   │       ids=[global_product_id],
   │       metadatas=[product_data]
   │   )
   │
   ▼
Step 5: Insert Store Listings (listings_scraped)
   │
   ├─→ INSERT INTO listings_scraped (...)
   ├─→ Store prices from multiple stores
   │
   ▼
Step 6: Rebuild Search Index
   │
   └─→ Update TF-IDF vectorizer with new product
</div></code></pre>
<h3 id="62-search-query-flow">6.2 Search Query Flow</h3>
<pre class="hljs"><code><div>┌─────────────────────────────────────────────────────────────┐
│                    SEARCH QUERY FLOW                        │
└─────────────────────────────────────────────────────────────┘

Step 1: User Upload
   │
   ├─→ Frontend: User uploads image + optional text
   ├─→ HTTP POST /api/search/hybrid
   │
   ▼
Step 2: Backend Processing
   │
   ├─→ Validate image (size, format)
   ├─→ Generate CLIP embedding
   │
   ▼
Step 3: Vector Search (ChromaDB)
   │
   ├─→ Query ChromaDB with image embedding
   ├─→ Get top 50 similar products
   ├─→ Time: ~500ms
   │
   ▼
Step 4: Keyword Search (TF-IDF)
   │
   ├─→ If query text provided:
   ├─→   Search product names/descriptions
   ├─→   Get top 50 matching products
   ├─→ Time: ~200ms
   │
   ▼
Step 5: Score Fusion
   │
   ├─→ Merge CLIP + Keyword results
   ├─→ Calculate weighted scores
   ├─→ Apply bonuses/penalties
   ├─→ Sort by final score
   │
   ▼
Step 6: Enrich Results
   │
   ├─→ Join with listings_scraped
   ├─→ Get prices from all stores
   ├─→ Calculate best price
   │
   ▼
Step 7: Return Results
   │
   └─→ JSON response with top 10 products
       Time: ~2-3 seconds total
</div></code></pre>
<h3 id="63-price-update-flow">6.3 Price Update Flow</h3>
<pre class="hljs"><code><div>┌─────────────────────────────────────────────────────────────┐
│                   PRICE UPDATE FLOW                         │
└─────────────────────────────────────────────────────────────┘

Step 1: Scheduled Job (Cron/Celery)
   │
   ├─→ Trigger every 6 hours
   │
   ▼
Step 2: Fetch Latest Prices
   │
   ├─→ Call Flipkart/Amazon APIs
   ├─→ Or: Run web scrapers
   │
   ▼
Step 3: Compare with Stored Price
   │
   ├─→ SELECT price FROM listings_scraped 
   │       WHERE listing_id = ?
   │
   ▼
Step 4: Update if Changed
   │
   ├─→ IF new_price != old_price:
   │       UPDATE listings_scraped
   │       INSERT INTO price_history
   │       Send price drop alert (if configured)
   │
   ▼
Step 5: Update Metadata
   │
   └─→ UPDATE last_scraped_at = NOW()
</div></code></pre>
<hr>
<h2 id="7-performance-optimizations">7. Performance Optimizations</h2>
<h3 id="71-database-optimizations">7.1 Database Optimizations</h3>
<h4 id="%F0%9F%9A%80-indexing-strategy">🚀 Indexing Strategy</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Category queries (most common)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_products_category <span class="hljs-keyword">ON</span> products_global(<span class="hljs-keyword">category</span>);

<span class="hljs-comment">-- Price sorting</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_listings_price <span class="hljs-keyword">ON</span> listings_scraped(price);

<span class="hljs-comment">-- Composite index for filtered queries</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_listings_product_stock 
    <span class="hljs-keyword">ON</span> listings_scraped(global_product_id, in_stock, price);

<span class="hljs-comment">-- Full-text search</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_products_name_fulltext 
    <span class="hljs-keyword">ON</span> products_global <span class="hljs-keyword">USING</span> gin(to_tsvector(<span class="hljs-string">'english'</span>, <span class="hljs-keyword">name</span>));

<span class="hljs-comment">-- JSONB specifications</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_products_specs 
    <span class="hljs-keyword">ON</span> products_global <span class="hljs-keyword">USING</span> gin(specifications);
</div></code></pre>
<p><strong>Performance Impact:</strong></p>
<ul>
<li>Category queries: <strong>10x faster</strong> (500ms → 50ms)</li>
<li>Price sorting: <strong>5x faster</strong> (1s → 200ms)</li>
<li>Full-text search: <strong>15x faster</strong> (3s → 200ms)</li>
</ul>
<h4 id="%F0%9F%94%84-connection-pooling">🔄 Connection Pooling</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># SQLAlchemy Connection Pool</span>
engine = create_engine(
    DATABASE_URL,
    pool_size=<span class="hljs-number">10</span>,              <span class="hljs-comment"># Normal pool size</span>
    max_overflow=<span class="hljs-number">20</span>,           <span class="hljs-comment"># Max additional connections</span>
    pool_timeout=<span class="hljs-number">30</span>,           <span class="hljs-comment"># Wait time for connection</span>
    pool_pre_ping=<span class="hljs-literal">True</span>,        <span class="hljs-comment"># Test connections before use</span>
    pool_recycle=<span class="hljs-number">3600</span>          <span class="hljs-comment"># Recycle connections after 1 hour</span>
)
</div></code></pre>
<p><strong>Benefits:</strong></p>
<ul>
<li>Avoid connection overhead (100ms per connection)</li>
<li>Handle concurrent requests efficiently</li>
<li>Automatic connection recycling prevents stale connections</li>
</ul>
<h3 id="72-embedding-optimizations">7.2 Embedding Optimizations</h3>
<h4 id="%E2%9A%A1-preloading-at-startup">⚡ Preloading at Startup</h4>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">preload_products_and_embeddings</span><span class="hljs-params">(self)</span>:</span>
    <span class="hljs-string">"""
    Load all products and generate embeddings at startup
    Eliminates 10-12 second delay on first search
    """</span>
    print(<span class="hljs-string">"🔄 Preloading products..."</span>)
    products = self.load_products_from_db()
    
    print(<span class="hljs-string">f"📦 Loaded <span class="hljs-subst">{len(products)}</span> products"</span>)
    print(<span class="hljs-string">"🧠 Generating text embeddings..."</span>)
    
    <span class="hljs-comment"># Generate embeddings for all products</span>
    descriptions = [p[<span class="hljs-string">'description'</span>] <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> products]
    text_embeddings = self.encode_text(descriptions)
    
    <span class="hljs-comment"># Cache in memory</span>
    self._cached_embeddings = text_embeddings
    self._cached_products = products
    
    print(<span class="hljs-string">"✅ Preloading complete! Search will be instant."</span>)
</div></code></pre>
<p><strong>Performance Impact:</strong></p>
<ul>
<li><strong>First search:</strong> 10-12 seconds → <strong>2-3 seconds</strong> (5x faster)</li>
<li><strong>Subsequent searches:</strong> Instant (&lt; 500ms)</li>
</ul>
<h4 id="%F0%9F%92%BE-caching-strategy">💾 Caching Strategy</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Memory cache for frequently accessed data</span>
CACHE = {
    <span class="hljs-string">'products'</span>: <span class="hljs-literal">None</span>,           <span class="hljs-comment"># All products</span>
    <span class="hljs-string">'embeddings'</span>: <span class="hljs-literal">None</span>,         <span class="hljs-comment"># CLIP embeddings</span>
    <span class="hljs-string">'tfidf_matrix'</span>: <span class="hljs-literal">None</span>,       <span class="hljs-comment"># TF-IDF matrix</span>
    <span class="hljs-string">'categories'</span>: <span class="hljs-literal">None</span>          <span class="hljs-comment"># Category list</span>
}

<span class="hljs-comment"># Redis cache for distributed systems (optional)</span>
redis_client = redis.Redis(
    host=<span class="hljs-string">'localhost'</span>,
    port=<span class="hljs-number">6379</span>,
    db=<span class="hljs-number">0</span>,
    decode_responses=<span class="hljs-literal">True</span>
)

<span class="hljs-comment"># Cache product search results</span>
redis_client.setex(
    <span class="hljs-string">f"search:<span class="hljs-subst">{image_hash}</span>"</span>,
    <span class="hljs-number">3600</span>,  <span class="hljs-comment"># 1 hour TTL</span>
    json.dumps(results)
)
</div></code></pre>
<h3 id="73-query-optimizations">7.3 Query Optimizations</h3>
<h4 id="%F0%9F%93%8A-optimized-query-examples">📊 Optimized Query Examples</h4>
<p><strong>Bad Query (N+1 Problem):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Fetch products</span>
products = db.execute_query(<span class="hljs-string">"SELECT * FROM products_global"</span>)

<span class="hljs-comment"># Fetch listings for each product (N queries!)</span>
<span class="hljs-keyword">for</span> product <span class="hljs-keyword">in</span> products:
    listings = db.execute_query(
        <span class="hljs-string">"SELECT * FROM listings_scraped WHERE global_product_id = ?"</span>,
        [product[<span class="hljs-string">'id'</span>]]
    )
</div></code></pre>
<p><strong>Good Query (Single JOIN):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Fetch everything in one query</span>
query = <span class="hljs-string">"""
SELECT 
    p.*,
    json_agg(l.*) as listings
FROM products_global p
LEFT JOIN listings_scraped l ON l.global_product_id = p.global_product_id
WHERE l.in_stock = true
GROUP BY p.global_product_id
"""</span>
results = db.execute_query(query)
</div></code></pre>
<p><strong>Performance:</strong></p>
<ul>
<li>Bad: 100 products × 10ms = <strong>1000ms</strong></li>
<li>Good: Single query = <strong>50ms</strong> (20x faster!)</li>
</ul>
<hr>
<h2 id="8-api-integration">8. API Integration</h2>
<h3 id="81-fastapi-endpoints">8.1 FastAPI Endpoints</h3>
<h4 id="%F0%9F%8C%90-hybrid-search-endpoint">🌐 Hybrid Search Endpoint</h4>
<pre class="hljs"><code><div><span class="hljs-meta">@router.post("/search/hybrid")</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">hybrid_search</span><span class="hljs-params">(
    file: UploadFile = File<span class="hljs-params">(...)</span>,
    query_text: str = Form<span class="hljs-params">(<span class="hljs-string">""</span>)</span>,
    top_k: int = Form<span class="hljs-params">(<span class="hljs-number">10</span>)</span>
)</span>:</span>
    <span class="hljs-string">"""
    Hybrid image + text search
    
    Args:
        file: Uploaded image
        query_text: Optional search query
        top_k: Number of results
    
    Returns:
        JSON with search results
    """</span>
    <span class="hljs-comment"># Read image</span>
    image_bytes = <span class="hljs-keyword">await</span> file.read()
    
    <span class="hljs-comment"># Perform search</span>
    search_engine = get_search_engine()
    results = search_engine.hybrid_search(
        image_bytes=image_bytes,
        query_text=query_text,
        top_k=top_k
    )
    
    <span class="hljs-comment"># Enrich with store listings</span>
    <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> results:
        listings = get_listings(result[<span class="hljs-string">'global_product_id'</span>])
        result[<span class="hljs-string">'listings'</span>] = listings
        result[<span class="hljs-string">'best_price'</span>] = min(l[<span class="hljs-string">'price'</span>] <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> listings)
    
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"success"</span>: <span class="hljs-literal">True</span>,
        <span class="hljs-string">"count"</span>: len(results),
        <span class="hljs-string">"results"</span>: results
    }
</div></code></pre>
<h4 id="%F0%9F%93%8A-database-statistics-endpoint">📊 Database Statistics Endpoint</h4>
<pre class="hljs"><code><div><span class="hljs-meta">@router.get("/stats/database")</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_database_stats</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-string">"""Get database statistics"""</span>
    db = DatabaseConnection()
    
    <span class="hljs-comment"># Count queries</span>
    stats = {
        <span class="hljs-string">"total_products"</span>: db.execute_query(
            <span class="hljs-string">"SELECT COUNT(*) as count FROM products_global"</span>
        )[<span class="hljs-number">0</span>][<span class="hljs-string">'count'</span>],
        
        <span class="hljs-string">"total_listings"</span>: db.execute_query(
            <span class="hljs-string">"SELECT COUNT(*) as count FROM listings_scraped"</span>
        )[<span class="hljs-number">0</span>][<span class="hljs-string">'count'</span>],
        
        <span class="hljs-string">"stores"</span>: db.execute_query(
            <span class="hljs-string">"SELECT DISTINCT store_name FROM listings_scraped"</span>
        ),
        
        <span class="hljs-string">"categories"</span>: db.execute_query(
            <span class="hljs-string">"SELECT category, COUNT(*) as count "</span> +
            <span class="hljs-string">"FROM products_global GROUP BY category"</span>
        )
    }
    
    <span class="hljs-keyword">return</span> stats
</div></code></pre>
<h3 id="82-database-connection-management">8.2 Database Connection Management</h3>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseConnection</span>:</span>
    <span class="hljs-string">"""Singleton database connection"""</span>
    
    _instance = <span class="hljs-literal">None</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__new__</span><span class="hljs-params">(cls)</span>:</span>
        <span class="hljs-keyword">if</span> cls._instance <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            cls._instance = super().__new__(cls)
            cls._instance.engine = create_engine(DATABASE_URL)
        <span class="hljs-keyword">return</span> cls._instance
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">execute_query</span><span class="hljs-params">(self, query: str, params: dict = None)</span>:</span>
        <span class="hljs-string">"""Execute SELECT query"""</span>
        <span class="hljs-keyword">with</span> self.engine.connect() <span class="hljs-keyword">as</span> conn:
            result = conn.execute(text(query), params <span class="hljs-keyword">or</span> {})
            <span class="hljs-keyword">return</span> [dict(row) <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> result.mappings()]
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">execute_update</span><span class="hljs-params">(self, query: str, params: dict = None)</span>:</span>
        <span class="hljs-string">"""Execute INSERT/UPDATE/DELETE"""</span>
        <span class="hljs-keyword">with</span> self.engine.begin() <span class="hljs-keyword">as</span> conn:
            result = conn.execute(text(query), params <span class="hljs-keyword">or</span> {})
            <span class="hljs-keyword">return</span> result.rowcount
</div></code></pre>
<hr>
<h2 id="9-deployment-architecture">9. Deployment Architecture</h2>
<h3 id="91-production-architecture">9.1 Production Architecture</h3>
<pre class="hljs"><code><div>┌───────────────────────────────────────────────────────────┐
│                    PRODUCTION STACK                       │
└───────────────────────────────────────────────────────────┘

┌──────────────────┐
│   Load Balancer  │ (Nginx / AWS ALB)
│   (SSL/TLS)      │
└────────┬─────────┘
         │
    ┌────┴────┐
    │         │
┌───▼──┐  ┌──▼───┐
│ API  │  │ API  │  (FastAPI instances)
│ Node │  │ Node │  (Gunicorn + Uvicorn workers)
│  #1  │  │  #2  │
└───┬──┘  └──┬───┘
    │        │
    └───┬────┘
        │
    ┌───▼────────────────────────────┐
    │                                │
┌───▼────────┐  ┌──────────┐  ┌────▼─────┐
│ PostgreSQL │  │ ChromaDB │  │  Redis   │
│  (Primary) │  │ (Vector) │  │  (Cache) │
│            │  │          │  │          │
│ • Products │  │ • CLIP   │  │ • Search │
│ • Listings │  │   vectors│  │   cache  │
│ • Prices   │  │ • 768-dim│  │ • Session│
└────────────┘  └──────────┘  └──────────┘
</div></code></pre>
<h3 id="92-environment-configuration">9.2 Environment Configuration</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># .env.production</span>
DATABASE_URL=postgresql://user:pass@db.example.com:5432/hypelens_prod
REDIS_URL=redis://cache.example.com:6379/0
CHROMA_HOST=chroma.example.com
CHROMA_PORT=8000

<span class="hljs-comment"># Performance</span>
WORKERS=4
THREADS=2
TIMEOUT=120

<span class="hljs-comment"># Security</span>
SECRET_KEY=&lt;strong-random-key&gt;
ALLOWED_HOSTS=api.example.com,www.example.com
CORS_ORIGINS=https://example.com
</div></code></pre>
<h3 id="93-scaling-considerations">9.3 Scaling Considerations</h3>
<h4 id="%F0%9F%93%88-horizontal-scaling">📈 Horizontal Scaling</h4>
<table>
<thead>
<tr>
<th>Component</th>
<th>Scaling Strategy</th>
<th>Max Capacity</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>API Servers</strong></td>
<td>Add more workers</td>
<td>10+ instances</td>
</tr>
<tr>
<td><strong>PostgreSQL</strong></td>
<td>Read replicas</td>
<td>5 replicas</td>
</tr>
<tr>
<td><strong>ChromaDB</strong></td>
<td>Distributed mode</td>
<td>Unlimited</td>
</tr>
<tr>
<td><strong>Redis</strong></td>
<td>Redis Cluster</td>
<td>100+ nodes</td>
</tr>
</tbody>
</table>
<h4 id="%F0%9F%92%BE-storage-estimates">💾 Storage Estimates</h4>
<table>
<thead>
<tr>
<th>Scale</th>
<th>Products</th>
<th>Embeddings</th>
<th>PostgreSQL</th>
<th>ChromaDB</th>
<th>Total</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Small</strong></td>
<td>1,000</td>
<td>768 MB</td>
<td>100 MB</td>
<td>5 MB</td>
<td>~1 GB</td>
</tr>
<tr>
<td><strong>Medium</strong></td>
<td>10,000</td>
<td>7.68 GB</td>
<td>1 GB</td>
<td>50 MB</td>
<td>~9 GB</td>
</tr>
<tr>
<td><strong>Large</strong></td>
<td>100,000</td>
<td>76.8 GB</td>
<td>10 GB</td>
<td>500 MB</td>
<td>~87 GB</td>
</tr>
<tr>
<td><strong>Enterprise</strong></td>
<td>1,000,000</td>
<td>768 GB</td>
<td>100 GB</td>
<td>5 GB</td>
<td>~873 GB</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="10-summary">10. Summary</h2>
<h3 id="%E2%9C%85-key-takeaways">✅ Key Takeaways</h3>
<ol>
<li>
<p><strong>Hybrid Database Architecture</strong></p>
<ul>
<li>PostgreSQL for relational data</li>
<li>ChromaDB for vector embeddings</li>
<li>SQLite for development/testing</li>
</ul>
</li>
<li>
<p><strong>Advanced Search</strong></p>
<ul>
<li>CLIP ViT-L/14 (768-dim embeddings)</li>
<li>TF-IDF keyword matching</li>
<li>Weighted score fusion</li>
</ul>
</li>
<li>
<p><strong>Performance Optimizations</strong></p>
<ul>
<li>Strategic indexing (10x faster queries)</li>
<li>Connection pooling</li>
<li>Embedding preloading (5x faster searches)</li>
<li>Result caching</li>
</ul>
</li>
<li>
<p><strong>Scalability</strong></p>
<ul>
<li>Supports 1M+ products</li>
<li>Distributed deployment ready</li>
<li>Horizontal scaling support</li>
</ul>
</li>
<li>
<p><strong>Production Ready</strong></p>
<ul>
<li>ACID compliance (PostgreSQL)</li>
<li>Automatic backups</li>
<li>Price history tracking</li>
<li>Analytics integration</li>
</ul>
</li>
</ol>
<hr>
<h2 id="%F0%9F%93%8A-database-statistics-current-system">📊 Database Statistics (Current System)</h2>
<pre class="hljs"><code><div><span class="hljs-comment">-- Total Products</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">FROM</span> products_global;
<span class="hljs-comment">-- Result: 50 products</span>

<span class="hljs-comment">-- Products with Embeddings</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">FROM</span> products_global <span class="hljs-keyword">WHERE</span> embedding_vector <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>;
<span class="hljs-comment">-- Result: 50 products (100%)</span>

<span class="hljs-comment">-- Categories</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">category</span>, <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">FROM</span> products_global <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">category</span>;
<span class="hljs-comment">-- Result:</span>
<span class="hljs-comment">--   Electronics: 8</span>
<span class="hljs-comment">--   Smartphones: 2</span>
<span class="hljs-comment">--   Laptops: 6</span>
<span class="hljs-comment">--   Others: 34</span>

<span class="hljs-comment">-- Average Search Time</span>
<span class="hljs-comment">-- CLIP Search: 500ms</span>
<span class="hljs-comment">-- Keyword Search: 200ms</span>
<span class="hljs-comment">-- Score Fusion: 50ms</span>
<span class="hljs-comment">-- Total: 2-3 seconds</span>
</div></code></pre>
<hr>
<h2 id="%F0%9F%93%9A-references">📚 References</h2>
<ol>
<li><strong>CLIP Paper</strong>: <a href="https://arxiv.org/abs/2103.00020">Learning Transferable Visual Models From Natural Language Supervision</a></li>
<li><strong>PostgreSQL Documentation</strong>: <a href="https://www.postgresql.org/docs/">https://www.postgresql.org/docs/</a></li>
<li><strong>ChromaDB Documentation</strong>: <a href="https://docs.trychroma.com/">https://docs.trychroma.com/</a></li>
<li><strong>SQLAlchemy Documentation</strong>: <a href="https://docs.sqlalchemy.org/">https://docs.sqlalchemy.org/</a></li>
<li><strong>OpenCLIP GitHub</strong>: <a href="https://github.com/mlfoundations/open_clip">https://github.com/mlfoundations/open_clip</a></li>
</ol>
<hr>
<p><strong>Document Version:</strong> 1.0<br>
<strong>Last Updated:</strong> October 25, 2025<br>
<strong>Author:</strong> AI Shopping Helper Development Team<br>
<strong>Status:</strong> Production Ready ✅</p>

</body>
</html>
